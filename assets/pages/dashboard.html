<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <!-- PWA Theme (Ø§Ø®ØªÙŠØ§Ø±ÙŠ ÙÙ‚Ø·) -->
    <meta name="theme-color" content="#6B1C24" />

    <meta name="description" content="Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†" />

    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | DriverSys</title>

    <!-- Fonts & Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../css/dashboard.css" />
  </head>
  <body id="dashboard-page">
    <!-- Mobile Overlay -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo-circle">DS</div>
        <div>
          <div class="brand-name">DriverSys</div>
          <div class="brand-tagline">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</div>
        </div>
      </div>

      <ul class="nav-menu">
        <li
          class="nav-item active"
          id="nav-cards"
          onclick="switchTab('cards', this)"
        >
          <i class="fas fa-id-card"></i>
          <span>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</span>
          <span class="nav-badge" id="cardsBadge">0</span>
        </li>
        <li class="nav-item" id="nav-users" onclick="switchTab('users', this)">
          <i class="fas fa-users"></i>
          <span>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
          <span class="nav-badge" id="usersBadge">0</span>
        </li>
        <li
          class="nav-item"
          id="nav-settings"
          onclick="switchTab('settings', this)"
        >
          <i class="fas fa-cog"></i>
          <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
        </li>
        <li
          class="nav-item external-link"
          onclick="window.location.href = '/assets/pages/card-template.html'"
        >
          <i class="fas fa-external-link-alt"></i>
          <span>Ø¥ØµØ¯Ø§Ø± Ø¨Ø·Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
          <i class="fas fa-arrow-left arrow-icon"></i>
        </li>
      </ul>

      <div class="sidebar-footer">
        <div class="user-mini-profile">
          <div class="user-mini-avatar" id="miniAvatar">A</div>
          <div class="user-mini-info">
            <div class="user-mini-name" id="miniName">Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</div>
            <div class="user-mini-role" id="miniRole">Ù…Ø¯ÙŠØ±</div>
          </div>
        </div>
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i>
          <span>ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="main-wrapper">
      <header class="top-header">
        <div class="header-right">
          <button class="menu-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
          </button>
          <div class="page-title" id="pageTitle">
            <i class="fas fa-id-card"></i>
            Ø³Ø¬Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
          </div>
        </div>

        <div class="header-actions">
          <button
            class="header-btn"
            onclick="showNotifications()"
            title="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª"
          >
            <i class="fas fa-bell"></i>
            <span class="badge">3</span>
          </button>
        </div>
      </header>

      <main class="content-area">
        <!-- Cards Tab -->
        <section id="cards" class="tab-content active">
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <i class="fas fa-id-card"></i>
                Ø³Ø¬Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
              </div>
              <div class="card-tools">
                <div class="search-box">
                  <i class="fas fa-search"></i>
                  <input
                    type="text"
                    id="cardsSearch"
                    placeholder="Ø¨Ø­Ø«..."
                    onkeyup="filterCards()"
                  />
                </div>
                <button class="btn btn-primary" onclick="exportCards()">
                  <i class="fas fa-download"></i>
                  ØªØµØ¯ÙŠØ±
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-container">
                <table class="data-table" id="cardsTable">
                  <thead>
                    <tr>
                      <th>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</th>
                      <th>Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
                      <th>Ø§Ù„Ù…Ù†Ø´Ø£Ø©</th>
                      <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                      <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                      <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                  </thead>
                  <tbody id="cardsTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- Users Tab -->
        <section id="users" class="tab-content">
          <div class="card users-container">
            <div class="card-header user-header-box">
              <div class="card-title">
                <i class="fas fa-users"></i>
                Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
              </div>
              <button class="btn btn-primary" onclick="openAddUserModal()">
                <i class="fas fa-plus"></i>
                Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…
              </button>
            </div>
            <div class="users-grid" id="usersGrid"></div>
          </div>
        </section>

        <!-- Settings Tab -->
        <section id="settings" class="tab-content">
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <i class="fas fa-cog"></i>
                Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
              </div>
            </div>
            <div class="card-body">
              <div class="empty-state">
                <i class="fas fa-tools"></i>
                <p>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±...</p>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- User Modal (Add/Edit) -->
    <div class="modal-overlay" id="userModal">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title" id="userModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</div>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editUserId" />
          <div class="input-group">
            <label class="form-label"> Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input
              type="text"
              class="form-control"
              id="newFullName"
              placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ù…Ù„"
            />
          </div>
          <div class="input-group">
            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <input
              type="text"
              class="form-control"
              id="newUsername"
              placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"
            />
          </div>
          <div class="input-group">
            <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="pass-input-wrapper" style="position: relative">
              <input
                type="password"
                class="form-control"
                id="newPassword"
                placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
                style="padding-left: 40px"
              />
              <button
                type="button"
                class="pass-toggle"
                onclick="toggleModalPassVisibility()"
                style="
                  position: absolute;
                  left: 10px;
                  top: 50%;
                  transform: translateY(-50%);
                  background: none;
                  border: none;
                  cursor: pointer;
                  color: #666;
                "
              >
                <i class="fas fa-eye" id="modalPassEye"></i>
              </button>
            </div>
          </div>
          <div class="input-group">
            <label class="form-label">Ø§Ù„Ø¯ÙˆØ±</label>
            <select class="form-control" id="newRole">
              <option value="1">Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… (Super Admin)</option>
              <option value="2">Ù…Ø¯ÙŠØ± (Admin)</option>
              <option value="3">Ù…Ø­Ø±Ø± (Editor)</option>
              <option value="4">Ù…Ø´Ø§Ù‡Ø¯ (Viewer)</option>
            </select>
            
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal()">
            Ø¥Ù„ØºØ§Ø¡
          </button>
          <button class="btn btn-primary" id="saveUserBtn" onclick="saveUser()">
            Ø­ÙØ¸
          </button>
        </div>
      </div>
    </div>
    
    <script>
      // ==========================================
      // Ù…Ù„Ù: dashboard.js (Ù…ÙØ­Ø¯Ù‘Ø« ÙˆÙ…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ API Ø§Ù„ØªÙˆØ«ÙŠÙ‚)
      // ==========================================

      // âœ… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù€ API
      const API_BASE_URL = "http://localhost/driver_cards/v1";

      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ† ÙˆÙ…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      const token =
        localStorage.getItem("authToken") ||
        sessionStorage.getItem("authToken");
      const userDataStr =
        localStorage.getItem("userData") || sessionStorage.getItem("userData");
      let currentUser = userDataStr ? JSON.parse(userDataStr) : null;

      // Global App Data
      const appData = {
        currentUser: currentUser || { name: "Ø²Ø§Ø¦Ø±", role_id: 4 },
        cards: [],
        users: [],
        statuses: [],
        roles: [],
      };

      // ğŸ”’ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ† Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
      document.addEventListener("DOMContentLoaded", () => {
        if (!token) {
          window.location.href = "index.html";
          return;
        }

        initPage();
        loadData();
      });

      async function loadData() {
        // âœ… Ø¥Ø¶Ø§ÙØ©: Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Ø± Ø£ÙŠØ¶Ø§Ù‹
        await Promise.all([
          fetchCards(),
          fetchUsers(),
          fetchStatuses(),
          fetchRoles(),
        ]);
        updateBadges();
        applyPermissions();
      }

      function initPage() {
        if (currentUser) {
          const displayName = currentUser.fullName || currentUser.username;
          document.getElementById("miniName").textContent = displayName;
          document.getElementById("miniAvatar").textContent = displayName
            .charAt(0)
            .toUpperCase();

          const roleNames = { 1: "Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…", 2: "Ù…Ø¯ÙŠØ±", 3: "Ù…Ø­Ø±Ø±", 4: "Ù…Ø´Ø§Ù‡Ø¯" };
          document.getElementById("miniRole").textContent =
            roleNames[currentUser.role_id] || "Ù…Ø³ØªØ®Ø¯Ù…";
        }
      }

      // ===== Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† API =====

      // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
      async function fetchCards() {
        try {
          const response = await fetch(`${API_BASE_URL}/cards`, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          if (response.status === 401) {
            // Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù†ØªÙ‡ÙŠ
            handleTokenExpired();
            return;
          }

          const result = await response.json();
          if (result.success) {
            appData.cards = result.cards || [];
            renderCards();
          } else {
            console.error("Error fetching cards:", result.error);
            showToast("error", "Ø®Ø·Ø£", result.error || "ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª");
          }
        } catch (error) {
          console.error("Network Error:", error);
          showToast("error", "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„", "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…");
        }
      }

      // 2. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
      async function fetchUsers() {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹ (Ø­Ø³Ø¨ Ø§Ù„ØªÙˆØ«ÙŠÙ‚: super_admin, admin ÙÙ‚Ø·)
        if (currentUser.role_id > 2) {
          hideUsersTab();
          return;
        }

        try {
          const response = await fetch(`${API_BASE_URL}/users`, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          if (response.status === 403) {
            hideUsersTab();
            return;
          }

          if (response.status === 401) {
            handleTokenExpired();
            return;
          }

          const result = await response.json();
          if (result.success) {
            appData.users = result.users || [];
            renderUsers();
          } else {
            console.error("Error fetching users:", result.error);
          }
        } catch (error) {
          console.error("Error fetching users:", error);
        }
      }

      // âœ… Ø¥Ø¶Ø§ÙØ© 3: Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª (Statuses)
      async function fetchStatuses() {
        try {
          const response = await fetch(`${API_BASE_URL}/statuses`, {
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          const result = await response.json();
          if (result.success) {
            appData.statuses = result.statuses || [];
            populateStatusFilter(appData.statuses);
          }
        } catch (error) {
          console.error("Error fetching statuses:", error);
        }
      }

      // âœ… Ø¥Ø¶Ø§ÙØ© 4: Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± (Roles)
      async function fetchRoles() {
        try {
          const response = await fetch(`${API_BASE_URL}/roles`, {
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          const result = await response.json();
          if (result.success) {
            appData.roles = result.roles || [];
            populateRoleSelect(appData.roles);
          }
        } catch (error) {
          console.error("Error fetching roles:", error);
        }
      }

      // ===== Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Renderers) =====

      function renderCards() {
        const tbody = document.getElementById("cardsTableBody");
        if (!tbody) return;

        if (appData.cards.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" style="text-align:center;padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª</td></tr>';
          return;
        }

        tbody.innerHTML = appData.cards
          .map(
            (card) => `
    <tr data-card-id="${card.card_id}">
      <td><strong>${card.card_number}</strong></td>
      <td>${card.driver_name_ar || "-"}</td>
      <td>${card.company_name_ar || "-"}</td>
      <td>${card.created_at ? card.created_at.split(" ")[0] : "-"}</td>
      <td>${getStatusBadge(card.status_name)}</td>
      <td>
        <div class="table-actions">
          <button class="btn-icon" onclick="viewCard('${
            card.card_id
          }')" title="Ø¹Ø±Ø¶">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn-icon action-edit" onclick="editCard('${
            card.card_id
          }')" title="ØªØ¹Ø¯ÙŠÙ„">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn-icon action-delete" onclick="deleteCard('${
            card.card_id
          }')" title="Ø­Ø°Ù">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </td>
    </tr>
  `
          )
          .join("");
      }

      function renderUsers() {
        const grid = document.getElementById("usersGrid");
        if (!grid) return;

        if (appData.users.length === 0) {
          grid.innerHTML =
            '<div style="text-align:center;padding:20px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>';
          return;
        }

        grid.innerHTML = appData.users
          .map((user) => {
            const roleName = getRoleName(user.role_id);
            return `
    <div class="user-card" data-id="${user.user_id}">
      <div class="user-avatar">
        ${(user.username || "U").charAt(0).toUpperCase()}
        <div class="user-status-dot ${
          user.is_active ? "active" : "inactive"
        }"></div>
      </div>
      <div class="user-name">${user.fullName || user.username}</div>
      <div class="user-role">${roleName}</div>
      <div class="user-actions">
        <button class="btn-action btn-edit action-edit" onclick="editUser('${
          user.user_id
        }')">
          <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„
        </button>
        <button class="btn-action btn-delete action-delete" onclick="deleteUser('${
          user.user_id
        }')">
          <i class="fas fa-trash"></i> Ø­Ø°Ù
        </button>
      </div>
    </div>
  `;
          })
          .join("");
      }

      // âœ… Ø¥Ø¶Ø§ÙØ©: Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ø­Ø§Ù„Ø§Øª
      function populateStatusFilter(statuses) {
        const filterSelect = document.getElementById("statusFilter");
        if (!filterSelect) return;

        filterSelect.innerHTML =
          '<option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>' +
          statuses
            .map((s) => `<option value="${s.status_id}">${s.name}</option>`)
            .join("");
      }

      // âœ… Ø¥Ø¶Ø§ÙØ©: Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
      function populateRoleSelect(roles) {
        const roleSelect = document.getElementById("newRole");
        if (!roleSelect) return;

        roleSelect.innerHTML = roles
          .map((r) => `<option value="${r.role_id}">${r.name}</option>`)
          .join("");
      }

      function getRoleName(roleId) {
        const roles = {
          1: "Super Admin",
          2: "Admin",
          3: "Editor",
          4: "Viewer",
        };
        return roles[roleId] || "User";
      }

      function getStatusBadge(statusName) {
        const statusMap = {
          approved: { class: "badge-success", text: "Ù…Ø¹ØªÙ…Ø¯Ø©" },
          draft: { class: "badge-warning", text: "Ù…Ø³ÙˆØ¯Ø©" },
          revoked: { class: "badge-danger", text: "Ù…Ù„ØºØ§Ø©" },
          expired: { class: "badge-secondary", text: "Ù…Ù†ØªÙ‡ÙŠØ©" },
        };

        const status = statusMap[statusName] || {
          class: "badge-light",
          text: statusName,
        };
        return `<span class="badge ${status.class}">${status.text}</span>`;
      }

      // ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª =====

      function applyPermissions() {
        const isViewer = currentUser.role_id === 4;
        const isEditor = currentUser.role_id === 3;
        const isAdmin = currentUser.role_id === 2;
        const isSuperAdmin = currentUser.role_id === 1;

        // Ø¥Ø®ÙØ§Ø¡ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ù…Ø­Ø±Ø± ÙˆØ§Ù„Ù…Ø´Ø§Ù‡Ø¯
        if (isViewer || isEditor) {
          hideUsersTab();
        }

        // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ ÙÙ‚Ø·
        if (isViewer) {
          document
            .querySelectorAll(".action-delete, .action-edit")
            .forEach((btn) => {
              btn.style.display = "none";
            });

          // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø©
          const addCardBtn = document.getElementById("addCardBtn");
          if (addCardBtn) addCardBtn.style.display = "none";
        }

        // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ù€ Admin (ÙÙ‚Ø· Super Admin ÙŠØ­Ø°Ù)
        if (!isSuperAdmin) {
          document
            .querySelectorAll(".user-actions .action-delete")
            .forEach((btn) => {
              btn.style.display = "none";
            });
        }
      }

      function hideUsersTab() {
        const usersTab = document.querySelector(".nav-item[data-tab='users']");
        if (usersTab) usersTab.style.display = "none";
      }

      // ===== Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª =====

      function viewCard(cardId) {
        const card = appData.cards.find((c) => c.card_id == cardId);
        if (!card) return;

        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙÙŠ Modal
        showCardDetailsModal(card);
      }

      function editCard(cardId) {
        const card = appData.cards.find((c) => c.card_id == cardId);
        if (!card) return;

        openCardModal(card);
      }

      // âœ… ØªØµØ­ÙŠØ­: Ø­Ø°Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Ø§Ø³ØªØ®Ø¯Ø§Ù… ? Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† &)
      async function deleteCard(cardId) {
        if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŸ")) return;

        try {
          const response = await fetch(
            `${API_BASE_URL}/cards?card_id=${cardId}`,
            {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          const result = await response.json();

          if (result.success) {
            showToast("success", "ØªÙ… Ø§Ù„Ø­Ø°Ù", "ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­");
            fetchCards();
            updateBadges();
          } else {
            showToast("error", "ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù", result.error || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø§");
          }
        } catch (error) {
          showToast("error", "Ø®Ø·Ø£", "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…");
        }
      }

      // âœ… Ø¥Ø¶Ø§ÙØ©: Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©
      async function createNewCard() {
        // 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ§Ù„ÙŠ
        const cardNumber = await getNextCardNumber();
        if (!cardNumber) return;

        // 2. ÙØªØ­ Modal Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ
        openCardModal(null, cardNumber);
      }

      // âœ… Ø¥Ø¶Ø§ÙØ©: Ø¬Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ§Ù„ÙŠ
      async function getNextCardNumber() {
        try {
          const response = await fetch(`${API_BASE_URL}/get_card_number`, {
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          const result = await response.json();
          if (result.success) {
            return result.id;
          }
          throw new Error(result.error || "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©");
        } catch (error) {
          showToast("error", "Ø®Ø·Ø£", error.message);
          return null;
        }
      }

      // âœ… Ø¥Ø¶Ø§ÙØ©: Ø­ÙØ¸ Ø¨Ø·Ø§Ù‚Ø© (Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ«)
      async function saveCard() {
        const cardId = document.getElementById("editCardId").value;
        const isEdit = !!cardId;

        const cardData = {
          driver_name_ar: document.getElementById("driverNameAr").value,
          driver_name_en: document.getElementById("driverNameEn").value,
          card_number: document.getElementById("cardNumber").value,
          driver_id: document.getElementById("driverId").value,
          issue_date: document.getElementById("issueDate").value,
          expiry_date: document.getElementById("expiryDate").value,
          license_number: document.getElementById("licenseNumber").value,
          company_name_ar: document.getElementById("companyNameAr").value,
          company_name_en: document.getElementById("companyNameEn").value,
          // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©
        };

        // Ø¥Ø¶Ø§ÙØ© verification_token Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        if (!isEdit) {
          cardData.verification_token = generateVerificationToken();
        } else {
          cardData.card_id = cardId;
        }

        try {
          const response = await fetch(`${API_BASE_URL}/cards`, {
            method: isEdit ? "PUT" : "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(cardData),
          });

          const result = await response.json();

          if (result.success) {
            showToast(
              "success",
              "ØªÙ… Ø§Ù„Ø­ÙØ¸",
              isEdit ? "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©" : "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­"
            );
            closeCardModal();
            fetchCards();
            updateBadges();
          } else {
            throw new Error(result.error || "ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©");
          }
        } catch (error) {
          showToast("error", "Ø®Ø·Ø£", error.message);
        }
      }

      function generateVerificationToken() {
        return (
          Math.random().toString(36).substring(2, 15) +
          Math.random().toString(36).substring(2, 15)
        );
      }

      // ===== Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† =====

      function openAddUserModal() {
        document.getElementById("userModalTitle").textContent =
          "Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯";
        document.getElementById("editUserId").value = "";
        document.getElementById("newUsername").value = "";
        document.getElementById("newFullName").value = ""; // âœ… Ø¥Ø¶Ø§ÙØ©: Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„
        document.getElementById("newPassword").value = "";
        document.getElementById("newRole").value = "4";
        document.getElementById("userModal").classList.add("active");
      }

      function editUser(userId) {
        const user = appData.users.find((u) => u.user_id == userId);
        if (!user) return;

        document.getElementById("userModalTitle").textContent =
          "ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…";
        document.getElementById("editUserId").value = user.user_id;
        document.getElementById("newUsername").value = user.username;
        document.getElementById("newFullName").value = user.fullName || ""; // âœ… Ø¥Ø¶Ø§ÙØ©
        document.getElementById("newPassword").value = "";
        document.getElementById("newRole").value = user.role_id;

        document.getElementById("userModal").classList.add("active");
      }

      // âœ… ØªØ­Ø¯ÙŠØ«: Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„
      async function saveUser() {
        const editId = document.getElementById("editUserId").value;
        const username = document.getElementById("newUsername").value.trim();
        const fullName = document.getElementById("newFullName").value.trim(); // âœ… Ø¥Ø¶Ø§ÙØ©
        const password = document.getElementById("newPassword").value;
        const role_id = parseInt(document.getElementById("newRole").value);

        if (!username)
          return showToast("error", "Ø®Ø·Ø£", "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
        if (!editId && !password)
          return showToast(
            "error",
            "Ø®Ø·Ø£",
            "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯"
          );

        const bodyData = {
          username,
          role_id,
          fullName, // âœ… Ø¥Ø¶Ø§ÙØ©
        };

        if (password) bodyData.password = password;
        if (editId) bodyData.user_id = editId;

        try {
          const method = editId ? "PUT" : "POST";
          const response = await fetch(`${API_BASE_URL}/users`, {
            method: method,
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(bodyData),
          });

          const result = await response.json();

          if (result.success) {
            showToast(
              "success",
              "ØªÙ… Ø§Ù„Ø­ÙØ¸",
              editId ? "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" : "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­"
            );
            closeModal();
            fetchUsers();
            updateBadges();
          } else {
            throw new Error(result.error || "ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©");
          }
        } catch (error) {
          showToast("error", "Ø®Ø·Ø£", error.message);
        }
      }

      async function deleteUser(userId) {
        if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")) return;

        try {
          const response = await fetch(`${API_BASE_URL}/users`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ user_id: userId }),
          });

          const result = await response.json();
          if (result.success) {
            showToast("success", "ØªÙ… Ø§Ù„Ø­Ø°Ù", "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­");
            fetchUsers();
            updateBadges();
          } else {
            showToast("error", "ÙØ´Ù„", result.error);
          }
        } catch (error) {
          showToast("error", "Ø®Ø·Ø£", "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„");
        }
      }

      // ===== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© =====

      function closeModal() {
        document.getElementById("userModal").classList.remove("active");
      }

      function closeCardModal() {
        document.getElementById("cardModal").classList.remove("active");
      }

      function openCardModal(card = null, prefillCardNumber = null) {
        const modal = document.getElementById("cardModal");
        const isEdit = !!card;

        document.getElementById("cardModalTitle").textContent = isEdit
          ? "ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø·Ø§Ù‚Ø©"
          : "Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©";
        document.getElementById("editCardId").value = card ? card.card_id : "";
        document.getElementById("cardNumber").value = card
          ? card.card_number
          : prefillCardNumber || "";
        document.getElementById("cardNumber").readOnly = !isEdit; // Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡

        if (card) {
          document.getElementById("driverNameAr").value =
            card.driver_name_ar || "";
          document.getElementById("driverNameEn").value =
            card.driver_name_en || "";
          document.getElementById("driverId").value = card.driver_id || "";
          document.getElementById("issueDate").value = card.issue_date || "";
          document.getElementById("expiryDate").value = card.expiry_date || "";
          document.getElementById("licenseNumber").value =
            card.license_number || "";
          document.getElementById("companyNameAr").value =
            card.company_name_ar || "";
          document.getElementById("companyNameEn").value =
            card.company_name_en || "";
        } else {
          // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          document.querySelectorAll("#cardModal input").forEach((input) => {
            if (input.id !== "cardNumber") input.value = "";
          });
        }

        modal.classList.add("active");
      }

      function showCardDetailsModal(card) {
        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙÙ‚Ø· Ù„Ù„Ø¹Ø±Ø¶
        const detailsHtml = `
    <div class="card-details">
      <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</strong> ${card.card_number}</p>
      <p><strong>Ø§Ù„Ø³Ø§Ø¦Ù‚:</strong> ${card.driver_name_ar}</p>
      <p><strong>Ø§Ù„Ø´Ø±ÙƒØ©:</strong> ${card.company_name_ar}</p>
      <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${getStatusBadge(card.status_name)}</p>
      <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</strong> ${card.created_at}</p>
    </div>
  `;

        // ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Modal Ù…Ù†ÙØµÙ„ Ø£Ùˆ Ù†ÙØ³ Modal Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        showToast("info", "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©", `Ø¨Ø·Ø§Ù‚Ø© Ø±Ù‚Ù… ${card.card_number}`);
      }

      function handleTokenExpired() {
        showToast("error", "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©", "ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
        setTimeout(() => {
          logout();
        }, 2000);
      }

      function toggleModalPassVisibility() {
        const input = document.getElementById("newPassword");
        const eye = document.getElementById("modalPassEye");
        const isPass = input.type === "password";
        input.type = isPass ? "text" : "password";
        eye.className = isPass ? "fas fa-eye-slash" : "fas fa-eye";
      }

      function filterCards() {
        const searchVal = document
          .getElementById("cardsSearch")
          .value.toLowerCase();
        const statusFilter = document.getElementById("statusFilter")?.value;

        document.querySelectorAll("#cardsTableBody tr").forEach((row) => {
          const textMatch = row.textContent.toLowerCase().includes(searchVal);
          const statusMatch =
            !statusFilter ||
            row
              .querySelector(".badge")
              ?.textContent.includes(
                appData.statuses.find((s) => s.status_id == statusFilter)
                  ?.name || ""
              );

          row.style.display = textMatch && statusMatch ? "" : "none";
        });
      }

      function updateBadges() {
        const cardsBadge = document.getElementById("cardsBadge");
        const usersBadge = document.getElementById("usersBadge");

        if (cardsBadge) cardsBadge.textContent = appData.cards.length;
        if (usersBadge) usersBadge.textContent = appData.users.length;
      }

      function exportCards() {
        if (appData.cards.length === 0) {
          showToast("warning", "ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±");
          return;
        }

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù€ CSV
        const headers = [
          "Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©",
          "Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚",
          "Ø§Ù„Ø´Ø±ÙƒØ©",
          "Ø§Ù„Ø­Ø§Ù„Ø©",
          "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡",
        ];
        const rows = appData.cards.map((c) => [
          c.card_number,
          c.driver_name_ar,
          c.company_name_ar,
          c.status_name,
          c.created_at,
        ]);

        const csvContent = [headers, ...rows]
          .map((e) => e.join(","))
          .join("\n");
        const blob = new Blob(["\ufeff" + csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "cards_export.csv";
        link.click();

        showToast("success", "ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±", "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù CSV");
      }

      function showToast(type, title, message) {
        const container = document.getElementById("toastContainer");
        if (!container) {
          console.warn("Toast container not found");
          alert(`${title}: ${message}`);
          return;
        }

        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        const icons = {
          success: "fa-check-circle",
          error: "fa-exclamation-circle",
          info: "fa-info-circle",
          warning: "fa-exclamation-triangle",
        };

        toast.innerHTML = `
    <i class="fas ${icons[type] || "fa-info"} toast-icon"></i>
    <div>
      <div class="toast-title">${title}</div>
      <div class="toast-msg">${message}</div>
    </div>
  `;

        container.appendChild(toast);
        setTimeout(() => toast.classList.add("show"), 10);
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 400);
        }, 3000);
      }

      function logout() {
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
          localStorage.removeItem("authToken");
          localStorage.removeItem("userData");
          localStorage.removeItem("userRoleId");
          sessionStorage.removeItem("authToken");
          sessionStorage.removeItem("userData");
          sessionStorage.removeItem("userRoleId");
          window.location.href = "index.html";
        }
      }

      function showNotifications() {
        showToast("info", "Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.");
      }

      // Sidebar & Navigation
      function toggleSidebar(force) {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("overlay");
        const isActive =
          typeof force === "boolean"
            ? force
            : !sidebar.classList.contains("active");
        sidebar.classList.toggle("active", isActive);
        overlay.classList.toggle("active", isActive);
      }

      function switchTab(tabId, element) {
        document
          .querySelectorAll(".tab-content")
          .forEach((tab) => tab.classList.remove("active"));
        document
          .querySelectorAll(".nav-item")
          .forEach((item) => item.classList.remove("active"));

        const targetTab = document.getElementById(tabId);
        if (targetTab) targetTab.classList.add("active");
        if (element) element.classList.add("active");

        const titles = {
          cards: { icon: "fa-id-card", text: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª" },
          users: { icon: "fa-users", text: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†" },
          settings: { icon: "fa-cog", text: "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª" },
        };

        const title = titles[tabId];
        if (title) {
          document.getElementById(
            "pageTitle"
          ).innerHTML = `<i class="fas ${title.icon}"></i> ${title.text}`;
        }

        if (window.innerWidth <= 768) toggleSidebar(false);
      }

      // Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeModal();
          closeCardModal();
        }
      });
    </script>
  </body>
</html>
