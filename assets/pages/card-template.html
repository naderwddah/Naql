<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø§Øª jsPDF Ùˆ html2canvas -->
    <script src="../js/jspdf.umd.min.js"></script>
    <script src="../js/html2canvas.min.js"></script>
    <script src="../js/qrcode.min.js"></script>
    <link rel="stylesheet" href="../css/card-template.css" />
  </head>

  <body>
    <div class="container">
      <h2 class="page-title">Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</h2>

      <form id="driverCardForm">
        <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
        <div class="section-title">
          ğŸ§¾ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ (Driver Card Info)
        </div>
        <div class="form-grid">
          <div class="form-group full-width">
            <label>Ø±Ù‚Ù… Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ (Driver Card Number)</label>
            <input
              type="text"
              id="driver_card_number"
              name="driver_card_number"
              readonly
              required
            />
          </div>

          <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø¹Ø±Ø¨ÙŠ)</label>
            <input
              type="text"
              name="driver_name_ar"
              onchange="changed()"
              onblur="translateTextToField(this.value, 'driver_name_en')"
              required
            />
          </div>

          <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label>
            <input
              type="text"
              name="driver_name_en"
              class="en-input"
              required
            />
          </div>

          <div class="form-group full-width">
            <label>Ø±Ù‚Ù… Ù‡ÙˆÙŠØ© Ø§Ù„Ø³Ø§Ø¦Ù‚</label>
            <input type="number" name="driver_id" required />
          </div>

          <div class="form-group">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</label>
            <input type="date" id="issue_date" name="issue_date" />
          </div>

          <div class="form-group">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
            <input type="date" id="expiry_date" name="expiry_date" readonly />
          </div>

          <div class="form-group full-width">
            <label>ØªØµÙ†ÙŠÙ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
            <input type="text" value="Ø³Ù†ÙˆÙŠ / Annual" readonly />
          </div>
        </div>

        <!-- QR -->
        <div class="qr-preview-container">
          <label>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø±Ù…Ø² QR</label>
          <img
            id="qr_preview_img"
            class="qr-preview-img"
            style="display: none"
          />
          <span id="qr_placeholder">Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ QR ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</span>
          <input type="hidden" id="qr_image_url" name="qr_image_url" />
        </div>

        <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø´Ø£Ø© -->
        <div class="section-title">ğŸ¢ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø´Ø£Ø© ÙˆØ§Ù„ØªØ±Ø®ÙŠØµ</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Ø±Ù‚Ù… Ø§Ù„ØªØ±Ø®ÙŠØµ</label>
            <input type="text" id="license_number" name="license_number" />
          </div>

          <div class="form-group">
            <label>Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ØªØ±Ø®ÙŠØµ (Ø¹Ø±Ø¨ÙŠ)</label>
            <input
              type="text"
              name="license_city_ar"
              onchange="changed()"
              onblur="translateTextToField(this.value, 'license_city_en')"
              required
            />
          </div>

          <div class="form-group">
            <label>Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ØªØ±Ø®ÙŠØµ (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label>
            <input
              type="text"
              name="license_city_en"
              class="en-input"
              required
            />
          </div>

          <div class="form-group">
            <label>ØªØ§Ø±ÙŠØ® Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªØ±Ø®ÙŠØµ</label>
            <input
              type="date"
              id="license_issue_date"
              name="license_issue_date"
            />
          </div>

          <div class="form-group">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ±Ø®ÙŠØµ</label>
            <input
              type="date"
              id="license_expiry_date"
              name="license_expiry_date"
              readonly
            />
          </div>

          <div class="form-group full-width">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø· (Ø¹Ø±Ø¨ÙŠ)</label>
            <input
              type="text"
              name="activity_type_ar"
              onchange="changed()"
              onblur="translateTextToField(this.value, 'activity_type_en')"
              required
            />
          </div>

          <div class="form-group full-width">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø· (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label>
            <input
              type="text"
              name="activity_type_en"
              class="en-input"
              required
            />
          </div>

          <div class="form-group full-width">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø© (Ø¹Ø±Ø¨ÙŠ)</label>
            <input
              type="text"
              name="company_name_ar"
              onchange="changed()"
              onblur="translateTextToField(this.value, 'company_name_en')"
              required
            />
          </div>

          <div class="form-group full-width">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø© (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label>
            <input
              type="text"
              name="company_name_en"
              class="en-input"
              required
            />
          </div>
        </div>

        <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
        <div class="actions">
          <button type="button" class="btn btn-preview" onclick="openPreview()">
            Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØµÙ…ÙŠÙ… (Preview)
          </button>
          <button
            type="button"
            class="btn btn-submit"
            onclick="handleFormSubmit()"
          >
            Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF (Print)
          </button>
        </div>
      </form>
    </div>

    <div id="previewModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closePreview()">&times;</span>
        <h3>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</h3>
        <div id="previewArea" class="preview-container">
          <!-- Ø³ÙŠØªÙ… ÙˆØ¶Ø¹ HTML Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù‡Ù†Ø§ -->
        </div>
        <button
          class="btn btn-submit"
          style="margin-top: 20px"
          onclick="confirmAndPrint()"
        >
          ØªØ£ÙƒÙŠØ¯ ÙˆØªÙ†Ø²ÙŠÙ„ PDF
        </button>
      </div>
    </div>

    <script>
      /* ===== Ø£Ø¯ÙˆØ§Øª ===== */
      function randomDigits(len) {
        return Math.floor(Math.random() * Math.pow(10, len))
          .toString()
          .padStart(len, "0");
      }

      let currentVerificationToken = null;

      /* ===== ØªÙˆÙ„ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ ===== */

      function setAutoDates() {
        const today = new Date();
        const nextYear = new Date(today);
        nextYear.setFullYear(today.getFullYear() + 1);

        const format = (d) => d.toISOString().split("T")[0];

        document.getElementById("issue_date").value = format(today);
        document.getElementById("expiry_date").value = format(nextYear);
        document.getElementById("license_issue_date").value = format(today);
        document.getElementById("license_expiry_date").value = format(nextYear);
      }
      function addOneYear(dateStr) {
        const d = new Date(dateStr);
        if (isNaN(d)) return "";
        d.setFullYear(d.getFullYear() + 1);
        return d.toISOString().split("T")[0];
      }

      const issueDate = document.getElementById("issue_date");
      const expiryDate = document.getElementById("expiry_date");

      issueDate.addEventListener("change", () => {
        expiryDate.value = addOneYear(issueDate.value);
      });

      const licenseIssue = document.getElementById("license_issue_date");
      const licenseExpiry = document.getElementById("license_expiry_date");

      licenseIssue.addEventListener("change", () => {
        licenseExpiry.value = addOneYear(licenseIssue.value);
      });

      function buildVerificationURL(token) {
        return `http://localhost/driver_cards/verify.html?token=${token}`;
      }
      /* ===== ØªÙˆÙ„ÙŠØ¯ QR ===== */

      function generateQR(url) {
        const img = document.getElementById("qr_preview_img");
        const placeholder = document.getElementById("qr_placeholder");
        const hidden = document.getElementById("qr_image_url");

        if (!img) {
          console.error("QR preview image element not found");
          return;
        }

        // ØªÙˆÙ„ÙŠØ¯ QR Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØªØ¨Ø© QRCode Ø¹Ù„Ù‰ canvas Ù…Ø¤Ù‚Øª
        const tempDiv = document.createElement("div");
        new QRCode(tempDiv, {
          text: url,
          width: 150,
          height: 150,
        });

        // Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø­ØªÙ‰ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ canvas
        setTimeout(() => {
          const canvas = tempDiv.querySelector("canvas");
          if (!canvas) {
            console.error("QR canvas not generated");
            return;
          }

          const base64 = canvas.toDataURL("image/png");

          // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©
          img.src = base64;
          img.style.display = "block";

          // Ø¥Ø®ÙØ§Ø¡ placeholder
          if (placeholder) {
            placeholder.style.display = "none";
          }

          // ØªØ®Ø²ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ hidden input
          if (hidden) {
            hidden.value = base64;
          }
        }, 100);
      }

      function generateToken() {
        const array = new Uint8Array(32);
        crypto.getRandomValues(array);

        return Array.from(array)
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");
      }

      const API_BASE_URL = "http://localhost/driver_cards/v1";

      async function apiRequest(endpoint, method = "GET", data = null) {
        const token =
          localStorage.getItem("authToken") ||
          sessionStorage.getItem("authToken");

        const headers = {
          "Content-Type": "application/json",
        };

        if (token) {
          headers["Authorization"] = `Bearer ${token}`;
        }

        const options = {
          method,
          headers,
        };

        if (data && method !== "GET") {
          options.body = JSON.stringify(data);
        }

        const response = await fetch(`${API_BASE_URL}/${endpoint}`, options);

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø·Ø£ HTTP
        if (!response.ok) {
          if (response.status === 401) {
            alert("Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹");
            window.location.href = "/login.html";
          }

          const errorText = await response.text();
          throw new Error(errorText || "Request failed");
        }

        return await response.json();
      }

      window.addEventListener("DOMContentLoaded", initPage);

      async function initPage() {
        try {
          // 1ï¸âƒ£ Ø¬Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
          const response = await apiRequest(
            "cards&get_card_number=get_card_number",
            "GET",
          );
          // console.log(response);
          const cardNumber = response.card_number;

          document.getElementById("driver_card_number").value = cardNumber;

          // ØªÙˆÙ„ÙŠØ¯ QR Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
          generateQR(cardNumber);

          // 1ï¸âƒ£ ØªÙˆÙ„ÙŠØ¯ token
          currentVerificationToken = generateToken();

          // 2ï¸âƒ£ Ø¨Ù†Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù‚Ù‚
          const verificationURL = buildVerificationURL(
            currentVerificationToken,
          );

          // 3ï¸âƒ£ ØªÙˆÙ„ÙŠØ¯ QR Ù„Ù„Ø±Ø§Ø¨Ø·
          generateQR(verificationURL);
          // 2ï¸âƒ£ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© (ØªÙˆØ§Ø±ÙŠØ® ÙÙ‚Ø·)
          setAutoDates();
        } catch (err) {
          console.error(err);
          alert("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±");
        }
      }

      /* ===== Ø§Ù„ØªØ±Ø¬Ù…Ø© ===== */
      let change = false;
      function changed() {
        change = true;
      }

      async function translateTextToField(arText, enFieldName) {
        if (!change || !arText.trim()) return;

        try {
          const res = await fetch(
            `https://api.mymemory.translated.net/get?q=${encodeURIComponent(arText)}&langpair=ar|en`,
          );
          const data = await res.json();
          document.querySelector(`[name="${enFieldName}"]`).value =
            data.responseData.translatedText;
        } catch {
          alert("ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©");
        }
        change = false;
      }

      // !------------------------------------
      // Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
      function openPreview() {
        const form = document.getElementById("driverCardForm");
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Ø¥Ù†Ø´Ø§Ø¡ HTML Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
        const cardHTML = generateCardHTML(data);
        document.getElementById("previewArea").innerHTML = cardHTML;
        document.getElementById("previewModal").style.display = "flex";
      }

      function closePreview() {
        document.getElementById("previewModal").style.display = "none";
      }

      // Ø§Ù„ØªØ£ÙƒÙŠØ¯ ÙˆØªÙ†Ø²ÙŠÙ„ PDF Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
      function confirmAndPrint() {
        closePreview();
        handleFormSubmit();
      }

      // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ HTML Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
      function generateCardHTML(data) {
        return `
      <div class="pdf-scope">
        <div class="card-preview" id="cardToPrint">
          <div class="card-bg-placeholder"></div>
            <img src="../images/1.png" class="bg-img" alt="Background" />
          
          <img class="card-qr" src="${data.qr_image_url}" alt="QR Code" />
          
          <div class="card-header">
            <h1>Ø¨Ø·Ø§Ù‚Ø© Ø³Ø§Ø¦Ù‚ - Driver Card</h1>
            <p>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${data.card_number}</p>
          </div>
          
          <div class="card-content">
            <!-- SECTION 1 -->
            <div class="card-section">
              <div class="card-section-title">
                <span>Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</span>
                <span class="card-ltr">Driver Card Info</span>
              </div>
              <div class="card-section-body">
                <div class="card-grid">
                  <div>
                    <div class="card-row"><span class="card-label">Ø±Ù‚Ù… Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚:</span><span class="card-value card-value-ar">${data.card_number}</span></div>
                    <div class="card-row"><span class="card-label">Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚:</span><span class="card-value card-value-ar">${data.driver_name_ar}</span></div>
                    <div class="card-row"><span class="card-label">Ø±Ù‚Ù… Ù‡ÙˆÙŠØ© Ø§Ù„Ø³Ø§Ø¦Ù‚:</span><span class="card-value card-value-ar">${data.driver_id}</span></div>
                    <div class="card-row"><span class="card-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±:</span><span class="card-value card-value-ar">${data.issue_date}</span></div>
                    <div class="card-row"><span class="card-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</span><span class="card-value card-value-ar">${data.expiry_date}</span></div>
                    <div class="card-row"><span class="card-label">ØªØµÙ†ÙŠÙ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</span><span class="card-value card-value-ar">${data.card_category_ar}</span></div>
                  </div>
                  <div class="card-ltr">
                    <div class="card-row"><span class="card-label">Driver Card Number:</span><span class="card-value card-value-en">${data.card_number}</span></div>
                    <div class="card-row"><span class="card-label">Driver Name:</span><span class="card-value card-value-en">${data.driver_name_en}</span></div>
                    <div class="card-row"><span class="card-label">Driver Id:</span><span class="card-value card-value-en">${data.driver_id}</span></div>
                    <div class="card-row"><span class="card-label">Issue Date:</span><span class="card-value card-value-en">${data.issue_date}</span></div>
                    <div class="card-row"><span class="card-label">Expiration Date:</span><span class="card-value card-value-en">${data.expiry_date}</span></div>
                    <div class="card-row"><span class="card-label">Card Category:</span><span class="card-value card-value-en">${data.card_category_en}</span></div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- SECTION 2 -->
            <div class="card-section">
              <div class="card-section-title">
                <span>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø´Ø£Ø© Ùˆ Ø§Ù„ØªØ±Ø®ÙŠØµ</span>
                <span class="card-ltr">License and Company Info</span>
              </div>
              <div class="card-section-body">
                <div class="card-grid">
                  <div>
                    <div class="card-row"><span class="card-label">Ø±Ù‚Ù… Ø§Ù„ØªØ±Ø®ÙŠØµ:</span><span class="card-value card-value-ar">${data.license_number}</span></div>
                    <div class="card-row"><span class="card-label">Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ØªØ±Ø®ÙŠØµ:</span><span class="card-value card-value-ar">${data.license_city_ar}</span></div>
                    <div class="card-row"><span class="card-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±:</span><span class="card-value card-value-ar">${data.license_issue_date}</span></div>
                    <div class="card-row"><span class="card-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</span><span class="card-value card-value-ar">${data.license_expiry_date}</span></div>
                    <div class="card-row"><span class="card-label">Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·:</span><span class="card-value card-value-ar">${data.activity_type_ar}</span></div>
                    <div class="card-row"><span class="card-label">Ø±Ù‚Ù… Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ù†Ø´Ø£Ø©:</span><span class="card-value card-value-ar">${data.moi_number ?? data.license_number}</span></div>
                    <div class="card-row"><span class="card-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©:</span><span class="card-value card-value-ar">${data.company_name_ar}</span></div>
                  </div>
                  <div class="card-ltr">
                    <div class="card-row"><span class="card-label">License Number:</span><span class="card-value card-value-en">${data.license_number}</span></div>
                    <div class="card-row"><span class="card-label">License City:</span><span class="card-value card-value-en">${data.license_city_en}</span></div>
                    <div class="card-row"><span class="card-label">Issue Date:</span><span class="card-value card-value-en">${data.license_issue_date}</span></div>
                    <div class="card-row"><span class="card-label">Expiry Date:</span><span class="card-value card-value-en">${data.license_expiry_date}</span></div>
                    <div class="card-row"><span class="card-label">Activity Type:</span><span class="card-value card-value-en">${data.activity_type_en}</span></div>
                    <div class="card-row"><span class="card-label">MOI Number:</span><span class="card-value card-value-en">${data.moi_number}</span></div>
                    <div class="card-row"><span class="card-label">Name:</span><span class="card-value card-value-en">${data.company_name_en}</span></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card-footer">
            <div>
              <p>
                * ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ø§Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­ÙƒÙˆÙ…ÙŠØ© ÙˆØºÙŠØ± Ù…Ø®ÙˆÙ„ Ù„ØµØ§Ø­Ø¨Ù‡Ø§
                Ù…Ù…Ø§Ø±Ø³Ø© Ø§Ù„Ù†Ø´Ø§Ø·
              </p>
              <p>* ÙŠØ¬Ø¨ Ø¥Ø¨Ø±Ø§Ø² Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„Ù…Ø®ÙˆÙ„ÙŠÙ† Ø¨ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªÙØªÙŠØ´ Ø¹Ù†Ø¯ Ø·Ù„Ø¨Ù‡Ø§.</p>
            </div>
            <div class="card-ltr">
              <p>
                * The card is used to close government procedures and its owner is
                not authorized to practice the activity
              </p>
              <p>* Kindly show this card to the authorized inspector if needed.</p>
            </div>
          </div>
        </div>
        </div>
      `;
      }

      async function handleFormSubmit() {
        const form = document.getElementById("driverCardForm");
        const submitBtn = document.querySelector(".btn-submit");
        const originalText = submitBtn.textContent;

        submitBtn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...";
        submitBtn.disabled = true;

        try {
          const formData = new FormData(form);
          const dataFromForm = Object.fromEntries(formData.entries());

          if (!currentVerificationToken) {
            alert("Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ QR Ø¨Ø¹Ø¯");
            return;
          }

          // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø© Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§
          const data = {
            driver_name_ar: dataFromForm.driver_name_ar || "",
            driver_name_en: dataFromForm.driver_name_en || "",
            driver_id: dataFromForm.driver_id || "",
            card_number:
              document.getElementById("driver_card_number").value || "",
            verification_token: currentVerificationToken,
            company_name_ar: dataFromForm.company_name_ar || "",
            company_name_en: dataFromForm.company_name_en || "",
            issue_date: document.getElementById("issue_date").value || "",
            expiry_date: document.getElementById("expiry_date").value || "",
            card_category_ar: "Ø³Ù†ÙˆÙŠ",
            card_category_en: "Annual",
            license_number: dataFromForm.license_number || "",
            license_city_ar: dataFromForm.license_city_ar || "",
            license_city_en: dataFromForm.license_city_en || "",
            license_issue_date:
              document.getElementById("license_issue_date").value || "",
            license_expiry_date:
              document.getElementById("license_expiry_date").value || "",
            activity_type_ar: dataFromForm.activity_type_ar || "",
            activity_type_en: dataFromForm.activity_type_en || "",
            moi_number:
              dataFromForm.moi_number || dataFromForm.license_number || "",
            qr_image_url: document.getElementById("qr_image_url").value || "",
          };

          // 1ï¸âƒ£ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³ÙŠØ±ÙØ±
          await apiRequest("cards", "POST", data);
          alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ PDF...");

          // 2ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ HTML Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§
          const cardHTML = generateCardHTML(data);
          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = cardHTML;
          tempDiv.style.position = "fixed";
          tempDiv.style.left = "-10000px";
          tempDiv.style.top = "0";
          document.body.appendChild(tempDiv);

          const cardElement = tempDiv.querySelector("#cardToPrint");

          // 3ï¸âƒ£ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„ØµÙˆØ± (Ø®Ø§ØµØ© QR ÙˆØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©)
          await Promise.all(
            Array.from(cardElement.querySelectorAll("img")).map((img) => {
              if (img.complete) return Promise.resolve();
              return new Promise(
                (resolve) => (img.onload = img.onerror = resolve),
              );
            }),
          );

          // 4ï¸âƒ£ ØªØ­ÙˆÙŠÙ„ HTML Ø¥Ù„Ù‰ Canvas
          const canvas = await html2canvas(cardElement, {
            scale: 2.5,
            useCORS: true,
            backgroundColor: "#ffffff",
          });

          document.body.removeChild(tempDiv);

          // 5ï¸âƒ£ ØªØ­ÙˆÙŠÙ„ px Ø¥Ù„Ù‰ mm
          const pxToMm = (px) => px * 0.264583;
          const pdfWidth = pxToMm(canvas.width);
          const pdfHeight = pxToMm(canvas.height);

          const { jsPDF } = window.jspdf;

          // 6ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ PDF Ø¨Ù†ÙØ³ Ø­Ø¬Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
          const pdf = new jsPDF({
            orientation: pdfWidth > pdfHeight ? "landscape" : "portrait",
            unit: "mm",
            format: [pdfWidth, pdfHeight],
          });

          const imgData = canvas.toDataURL("image/png", 1.0);

          pdf.addImage(
            imgData,
            "PNG",
            0,
            0,
            pdfWidth,
            pdfHeight,
            undefined,
            "FAST",
          );

          // 7ï¸âƒ£ Ø­ÙØ¸ PDF
          pdf.save(`driver-card-${data.card_number}.pdf`);
          alert("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­");
        } catch (err) {
          console.error(err);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: " + err.message);
        } finally {
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      }

      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡
      window.onclick = function (event) {
        const modal = document.getElementById("previewModal");
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };
    </script>
  </body>
</html>
